import streamlit as st
import pandas as pd

# 1. ページ設定
st.set_page_config(page_title="学区・教育環境ナビ", layout="wide")

# CSS: デザイン維持
st.markdown("""
    <style>
    header { visibility: hidden; }
    .block-container { padding-top: 1rem !important; overflow: visible !important; }
    .main-header { 
        font-size: 24px; font-weight: bold; color: #1a365d; 
        text-align: center; border-bottom: 3px solid #3498db;
        padding-bottom: 10px; margin-bottom: 15px; 
    }
    .highlight-box {
        background-color: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        margin-bottom: 20px;
    }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th { background-color: #f2f2f2; text-align: center !important; padding: 10px; font-size: 14px; border-bottom: 2px solid #ddd; }
    td { border-bottom: 1px solid #ddd; padding: 10px; text-align: center !important; font-size: 14px; }
    </style>
""", unsafe_allow_html=True)

st.markdown('<div class="main-header">🏫 学区・教育環境ガイド</div>', unsafe_allow_html=True)

# --- 21校データ ---
school_data = [
    {"順位": 1, "学校名": "開成中学校", "偏差値": 72, "カテゴリ": "男子校", "所在地": "荒川区", "最寄り": "西日暮里"},
    {"順位": 2, "学校名": "麻布中学校", "偏差値": 68, "カテゴリ": "男子校", "所在地": "港区", "最寄り": "広尾"},
    {"順位": 3, "学校名": "駒場東邦中学校", "偏差値": 67, "カテゴリ": "男子校", "所在地": "世田谷区", "最寄り": "駒場東大前"},
    {"順位": 4, "学校名": "武蔵中学校", "偏差値": 65, "カテゴリ": "男子校", "所在地": "練馬区", "最寄り": "江古田"},
    {"順位": 5, "学校名": "海城中学校", "偏差値": 64, "カテゴリ": "男子校", "所在地": "新宿区", "最寄り": "新大久保"},
    {"順位": 6, "学校名": "早稲田中学校", "偏差値": 64, "カテゴリ": "男子校", "所在地": "新宿区", "最寄り": "早稲田"},
    {"順位": 7, "学校名": "本郷中学校", "偏差値": 60, "カテゴリ": "男子校", "所在地": "豊島区", "最寄り": "巣鴨"},
    {"順位": 1, "学校名": "桜蔭中学校", "偏差値": 71, "カテゴリ": "女子校", "所在地": "文京区", "最寄り": "水道橋"},
    {"順位": 2, "学校名": "女子学院中学校", "偏差値": 69, "カテゴリ": "女子校", "所在地": "千代田区", "最寄り": "市ヶ谷"},
    {"順位": 3, "学校名": "豊島岡女子学園", "偏差値": 68, "カテゴリ": "女子校", "所在地": "豊島区", "最寄り": "池袋"},
    {"順位": 4, "学校名": "雙葉中学校", "偏差値": 67, "カテゴリ": "女子校", "所在地": "千代田区", "最寄り": "四ツ谷"},
    {"順位": 5, "学校名": "白百合学園", "偏差値": 64, "カテゴリ": "女子校", "所在地": "千代田区", "最寄り": "九段下"},
    {"順位": 6, "学校名": "吉祥女子中学校", "偏差値": 63, "カテゴリ": "女子校", "所在地": "武蔵野市", "最寄り": "吉祥寺"},
    {"順位": 7, "学校名": "鴎友学園女子", "偏差値": 62, "カテゴリ": "女子校", "所在地": "世田谷区", "最寄り": "宮の坂"},
    {"順位": 1, "学校名": "渋谷教育学園渋谷", "偏差値": 70, "カテゴリ": "共学", "所在地": "渋谷区", "最寄り": "渋谷"},
    {"順位": 2, "学校名": "筑波大学附属", "偏差値": 69, "カテゴリ": "共学", "所在地": "文京区", "最寄り": "護国寺"},
    {"順位": 3, "学校名": "広尾学園", "偏差値": 66, "カテゴリ": "共学", "所在地": "港区", "最寄り": "広尾"},
    {"順位": 4, "学校名": "慶應義塾中等部", "偏差値": 65, "カテゴリ": "共学", "所在地": "港区", "最寄り": "三田"},
    {"順位": 5, "学校名": "早稲田実業学校", "偏差値": 65, "カテゴリ": "共学", "所在地": "国分寺市", "最寄り": "国分寺"},
    {"順位": 6, "学校名": "芝浦工業大学附属", "偏差値": 62, "カテゴリ": "共学", "所在地": "江東区", "最寄り": "豊洲"},
    {"順位": 7, "学校名": "三田国際学園", "偏差値": 61, "カテゴリ": "共学", "所在地": "世田谷区", "最寄り": "用賀"},
]

# --- 自治体データ（区外追加） ---
base_ward_data = [
    {"区": "千代田区", "教育特色": "ICT教育の質が高く、全校に専任支援員を配置。九段中等教育学校が人気。", "独自支援": "「次世代育成手当」月5000円を独自支給。誕生祝金など予算投入額はトップ級。"},
    {"区": "中央区", "教育特色": "晴海フラッグ等に伴う校舎新設。放課後遊び場「プレディ」を全校実施。", "独自支援": "新生児に3万円分のタクシー券等。第2子以降の保育料完全無償化を先行導入。"},
    {"区": "港区", "教育特色": "全校にネイティブ講師。小中一貫教育やICT環境を活用した反転学習が定評。", "独自支援": "出産費用助成が最大60万円（23区最高）。私立幼稚園入園料補助も手厚い。"},
    {"区": "新宿区", "教育特色": "日本語指導が必要な児童へのフォローが23区随一。スタディサプリを全戸導入。", "独自支援": "「子どもショートステイ」制度が充実。急な預かり先の確保がしやすい。"},
    {"区": "文京区", "教育特色": "御三家公立小を筆頭に学力レベルが極めて高い。国立大附属校も多い「教育の府」。", "独自支援": "「文京区版ネウボラ」による伴走支援。教育相談や不登校対策の質が高い。"},
    {"区": "台東区", "教育特色": "上野の博物館等と連携した文化体験教育。伝統工芸を学ぶ授業も特色。", "独自支援": "入学お祝い金を支給。区外からの転入ファミリー向け家賃助成もあり。"},
    {"区": "墨田区", "教育特色": "ものづくり教育と地場産業連携。最新校舎への改築を積極的に推進。", "独自支援": "「すみだ型ネウボラ」で妊娠期から保健師が継続サポート。私立幼稚園補助が厚い。"},
    {"区": "江東区", "教育特色": "湾岸の最新教育設備。理数教育（理数インター等）や土曜塾が充実。", "独自支援": "待機児童ゼロを達成。第2子以降の保育料無償化。独自アプリの情報発信が迅速。"},
    {"区": "品川区", "教育特色": "小中一貫教育の先駆。独自教科「市民科」でプレゼン力・論理力を育成。", "独自支援": "「しながわネウボラ」で育児用品配布。シルバー人材連携の預かり機能が強固。"},
    {"区": "目黒区", "教育特色": "電子黒板・タブレット完備で思考力を可視化。教育熱心な世帯が多い地域。", "独自支援": "子育て支援センター「ほっぺ」の利便性が高い。産後ケア助成も手厚い。"},
    {"区": "大田区", "教育特色": "町工場や航空会社と連携した理数・キャリア教育。全校で「放課後ひろば」実施。", "独自支援": "子育てひろば「ぴよぴよ」を各所に配置。第3子以降の出産祝金制度あり。"},
    {"区": "世田谷区", "教育特色": "「せたがやの教育」で食育や日本語教育に定評。コミュニティスクールも活発。", "独自支援": "子育て利用券配布。児童館数は23区最多。産後ケアセンター発祥の地。"},
    {"区": "渋谷区", "教育特色": "1人1台のセルラーモデルiPadを配布。サイバーエージェント等と連携したIT教育。", "独自支援": "出産助成金10万円上乗せ。育児用品レンタル補助などスマートな支援。"},
    {"区": "中野区", "教育特色": "情報モラル教育とICTの融合。最新のラーニングコモンズ設置校が増加中。", "独自支援": "子育て応援ギフト計10万円。セカンドブック（2歳児向け絵本）も実施。"},
    {"区": "杉並区", "教育特色": "習熟度別学習を徹底。保護者による学校評価を公開し、質を担保。", "独自支援": "「すぎなみ子育て応援券（最大4万円分）」で幅広い育児サービスが利用可能。"},
    {"区": "豊島区", "教育特色": "待機児童ゼロ継続。スキップでの学習支援、SDGs教育を軸とした人材育成。", "独自支援": "所得制限なしで第2子以降保育料無償化。子育てマイページで行政手続を効率化。"},
    {"区": "北区", "教育特色": "「子育てするなら北区」を掲げ、独自の学習診断テストや給食費無償化を導入。", "独自支援": "安心ママパパ応援団による家事支援が安価。地域全体での子育て支援。"},
    {"区": "荒川区", "教育特色": "「読書のまち」。全校に専任司書を配置。全国学力調査の成績が急上昇中。", "独自支援": "おむつ専用ごみ袋の無料配布や、中学生向けの塾代助成など家計に直結する支援。"},
    {"区": "板橋区", "教育特色": "レッジョ・エミリア教育を取り入れた幼児教育。全校コミュニティスクール化。", "独自支援": "「すくすくカード」で有料支援が利用可能。公園内でのプレーパーク活動が盛ん。"},
    {"区": "練馬区", "教育特色": "公立校数が23区最多。読み書き計算とICTのバランスが良い安定した教育。", "独自支援": "第3子誕生祝金10万円。幼稚園での預かり「練馬こども園」認定を拡大。"},
    {"区": "足立区", "教育特色": "「足立っ子学習塾」など学校外教育の補完が凄まじい。学力の伸びは都内随一。", "独自支援": "貧困対策としての食支援・居場所づくり。私立高校授業料補助も手厚い。"},
    {"区": "葛飾区", "教育特色": "給食費完全無償化をいち早く実施。校舎耐震改築率100%を達成済み。", "独自支援": "マタニティパス配布。3人乗り自転車購入補助など移動支援も充実。"},
    {"区": "江戸川区", "教育特色": "学童機能「すくすくスクール」が充実。スポーツを通じた人格形成に注力。", "独自支援": "「乳児養育手当」月1.3万円を支給。孫育て支援など3世代同居を推進。"},
    # 区外追加
    {"区": "武蔵野市", "教育特色": "吉祥寺エリアを含む文教地区。独自の「武蔵野市教育ビジョン」に基づき、1人1台端末を活用した市民性教育を展開。", "独自支援": "「こども110番」活動や地域見守りが非常に強固。独自の奨学金制度や教育相談員が全小中学校に配置。"},
    {"区": "国分寺市", "教育特色": "「文教都市」として知られ、早実などの名門校を擁する。理数教育の充実と、地域資源を活かしたフィールドワーク学習が盛ん。", "独自支援": "「子育てアプリ」による予防接種・検診管理が充実。産前産後のサポート事業や、保育園の質を担保する独自基準がある。"}
]

# --- メインロジック ---
df_school = pd.DataFrame(school_data)
df_ward = pd.DataFrame(base_ward_data)

# 星付き名称のリスト作成（カウントロジック修正）
def get_star_ward_name(ward_name):
    # school_dataの「所在地」カラムと完全一致する件数を数える
    count = len(df_school[df_school["所在地"] == ward_name])
    return f"{ward_name}{'★' * count}"

ward_options = [get_star_ward_name(w) for w in df_ward["区"]]

st.write("### 📍 エリアを選択してください")

# 文京区（文京区★★）を初期値として設定（base_ward_data内のindex=4）
selected_option = st.selectbox("自治体を選択", ward_options, index=4, label_visibility="collapsed")
selected_ward_raw = selected_option.split("★")[0]

ward_info = df_ward[df_ward["区"] == selected_ward_raw].iloc[0]
st.markdown(f"""
    <div class="highlight-box">
        <h3 style="margin-top:0; color:#1a365d;">{selected_option} の子育て環境</h3>
        <p style="line-height:1.6;"><b>■ 教育・学校特色:</b><br>{ward_info['教育特色']}</p>
        <p style="line-height:1.6;"><b>■ 独自の自治体支援:</b><br>{ward_info['独自支援']}</p>
    </div>
""", unsafe_allow_html=True)

def show_centered_table(df):
    st.write(df.to_html(index=False, escape=False, justify='center'), unsafe_allow_html=True)

# 選択された区に所在する学校を抽出
local_schools = df_school[df_school["所在地"] == selected_ward_raw]

if not local_schools.empty:
    st.markdown(f"#### ✨ {selected_ward_raw}内の難関校")
    show_centered_table(local_schools[["順位", "学校名", "偏差値", "カテゴリ", "最寄り"]])
else:
    st.info(f"※{selected_ward_raw}内に所在する難関校（偏差値60以上）はリスト外です。")

st.markdown("---")
st.write("### 🏆 東京都 難関私立中学 TOP7 一覧")

col1, col2, col3 = st.columns(3)
with col1:
    st.markdown('<p style="color:#3498db; font-weight:bold; border-bottom:2px solid #3498db; text-align:center;">🟦 男子校</p>', unsafe_allow_html=True)
    show_centered_table(df_school[df_school["カテゴリ"] == "男子校"].sort_values("順位")[["順位", "学校名", "偏差値"]])
with col2:
    st.markdown('<p style="color:#e91e63; font-weight:bold; border-bottom:2px solid #e91e63; text-align:center;">🟥 女子校</p>', unsafe_allow_html=True)
    show_centered_table(df_school[df_school["カテゴリ"] == "女子校"].sort_values("順位")[["順位", "学校名", "偏差値"]])
with col3:
    st.markdown('<p style="color:#9b59b6; font-weight:bold; border-bottom:2px solid #9b59b6; text-align:center;">🟪 共学</p>', unsafe_allow_html=True)
    show_centered_table(df_school[df_school["カテゴリ"] == "共学"].sort_values("順位")[["順位", "学校名", "偏差値"]])
